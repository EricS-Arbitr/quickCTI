{
  "simple_ioc_searches": [
    {
      "description": "Search for PinchDuke indicators",
      "sql_query": "\n-- Search for PinchDuke in process execution logs\nSELECT timestamp, host, process_name, command_line, parent_process, user\nFROM process_logs\nWHERE process_name LIKE '%pinchduke%'\n   OR command_line LIKE '%pinchduke%'\nORDER BY timestamp DESC;",
      "log_types": [
        "Windows Event Logs",
        "Sysmon",
        "EDR"
      ]
    },
    {
      "description": "Search for ROADTools indicators",
      "sql_query": "\n-- Search for ROADTools in process execution logs\nSELECT timestamp, host, process_name, command_line, parent_process, user\nFROM process_logs\nWHERE process_name LIKE '%roadtools%'\n   OR command_line LIKE '%roadtools%'\nORDER BY timestamp DESC;",
      "log_types": [
        "Windows Event Logs",
        "Sysmon",
        "EDR"
      ]
    },
    {
      "description": "Search for WellMail indicators",
      "sql_query": "\n-- Search for WellMail in process execution logs\nSELECT timestamp, host, process_name, command_line, parent_process, user\nFROM process_logs\nWHERE process_name LIKE '%wellmail%'\n   OR command_line LIKE '%wellmail%'\nORDER BY timestamp DESC;",
      "log_types": [
        "Windows Event Logs",
        "Sysmon",
        "EDR"
      ]
    },
    {
      "description": "Search for CozyCar indicators",
      "sql_query": "\n-- Search for CozyCar in process execution logs\nSELECT timestamp, host, process_name, command_line, parent_process, user\nFROM process_logs\nWHERE process_name LIKE '%cozycar%'\n   OR command_line LIKE '%cozycar%'\nORDER BY timestamp DESC;",
      "log_types": [
        "Windows Event Logs",
        "Sysmon",
        "EDR"
      ]
    },
    {
      "description": "Search for Mimikatz indicators",
      "sql_query": "\n-- Search for Mimikatz in process execution logs\nSELECT timestamp, host, process_name, command_line, parent_process, user\nFROM process_logs\nWHERE process_name LIKE '%mimikatz%'\n   OR command_line LIKE '%mimikatz%'\nORDER BY timestamp DESC;",
      "log_types": [
        "Windows Event Logs",
        "Sysmon",
        "EDR"
      ]
    }
  ],
  "behavioral_patterns": [
    {
      "description": "Detect credential access attempts",
      "sql_query": "\n-- LSASS access and credential dumping\nSELECT timestamp, host, process_name, command_line, user, target_process\nFROM process_logs\nWHERE (\n    -- LSASS access\n    target_process = 'lsass.exe'\n    -- Credential dumping tools\n    OR command_line LIKE '%procdump%lsass%'\n    OR command_line LIKE '%mimikatz%'\n    OR command_line LIKE '%sekurlsa%'\n    OR process_name IN ('procdump.exe', 'procdump64.exe')\n    -- Registry credential access\n    OR command_line LIKE '%reg save%HKLM\\SAM%'\n    OR command_line LIKE '%reg save%HKLM\\SECURITY%'\n)\nORDER BY timestamp DESC;",
      "log_types": [
        "Windows Event Logs",
        "Sysmon",
        "EDR"
      ],
      "technique_id": "T1003.002",
      "technique_name": "Security Account Manager"
    }
  ],
  "chained_events": [
    {
      "chain_name": "Initial Compromise to Persistence",
      "description": "Detect initial access followed by execution and persistence establishment",
      "stages": [
        "initial-access",
        "execution",
        "persistence"
      ],
      "sql_query": "\n-- Multi-stage detection: Email \u2192 Execution \u2192 Persistence\nWITH email_events AS (\n    SELECT timestamp as email_time, recipient_host, attachment_name\n    FROM email_logs\n    WHERE attachment_name LIKE '%.exe' OR attachment_name LIKE '%.zip'\n),\nexecution_events AS (\n    SELECT timestamp as exec_time, host, process_name, command_line, parent_process\n    FROM process_logs\n    WHERE parent_process IN ('outlook.exe', 'winword.exe', 'excel.exe')\n),\npersistence_events AS (\n    SELECT timestamp as persist_time, host, registry_key, registry_value\n    FROM registry_logs\n    WHERE registry_key LIKE '%\\Run%' \n       OR registry_key LIKE '%\\RunOnce%'\n)\nSELECT \n    e.email_time, e.recipient_host, e.attachment_name,\n    ex.exec_time, ex.process_name, ex.command_line,\n    p.persist_time, p.registry_key, p.registry_value\nFROM email_events e\nJOIN execution_events ex \n    ON e.recipient_host = ex.host \n    AND ex.exec_time BETWEEN e.email_time AND e.email_time + INTERVAL '10 minutes'\nJOIN persistence_events p \n    ON ex.host = p.host \n    AND p.persist_time BETWEEN ex.exec_time AND ex.exec_time + INTERVAL '5 minutes'\nORDER BY e.email_time DESC;",
      "log_types": [
        "Email Gateway",
        "Windows Event Logs",
        "Sysmon",
        "EDR"
      ],
      "time_window": "10-15 minutes",
      "techniques": [
        "T1546.003",
        "T1547.001",
        "T1136.003",
        "T1098.005",
        "T1651",
        "T1566.001",
        "T1078.004",
        "T1053.005",
        "T1037",
        "T1203",
        "T1204.001",
        "T1556.007",
        "T1059.001",
        "T1133",
        "T1037.004",
        "T1566.002",
        "T1047",
        "T1199",
        "T1566.003",
        "T1078",
        "T1505.003",
        "T1059.006",
        "T1190",
        "T1098.002",
        "T1078.003",
        "T1546.008",
        "T1059.009",
        "T1204.002"
      ]
    },
    {
      "chain_name": "Discovery and Lateral Movement",
      "description": "Detect reconnaissance followed by lateral movement attempts",
      "stages": [
        "execution",
        "discovery",
        "lateral-movement"
      ],
      "sql_query": "\n-- Detect discovery commands followed by lateral movement\nWITH discovery_commands AS (\n    SELECT timestamp as disc_time, host, user, command_line\n    FROM process_logs\n    WHERE command_line LIKE '%net view%'\n       OR command_line LIKE '%net user%'\n       OR command_line LIKE '%net group%'\n       OR command_line LIKE '%nltest%'\n       OR command_line LIKE '%dsquery%'\n       OR command_line LIKE '%ipconfig%'\n       OR command_line LIKE '%whoami%'\n),\nlateral_movement AS (\n    SELECT timestamp as lat_time, src_host, dst_host, user, service_name\n    FROM authentication_logs\n    WHERE event_type = 'RemoteLogon'\n       OR service_name IN ('psexec', 'wmi', 'winrm')\n)\nSELECT \n    d.disc_time, d.host as source_host, d.user, d.command_line,\n    l.lat_time, l.dst_host as target_host, l.service_name\nFROM discovery_commands d\nJOIN lateral_movement l \n    ON d.host = l.src_host \n    AND d.user = l.user\n    AND l.lat_time BETWEEN d.disc_time AND d.disc_time + INTERVAL '30 minutes'\nORDER BY d.disc_time DESC;",
      "log_types": [
        "Windows Event Logs",
        "Sysmon",
        "Network Logs"
      ],
      "time_window": "30 minutes",
      "techniques": [
        "T1016.001",
        "T1550.003",
        "T1021.007",
        "T1087.004"
      ]
    },
    {
      "chain_name": "PowerShell C2 Callback",
      "description": "Detect PowerShell execution immediately followed by network connection",
      "stages": [
        "execution",
        "command-and-control"
      ],
      "sql_query": "\n-- PowerShell execution with immediate network callback\nWITH powershell_exec AS (\n    SELECT timestamp as ps_time, host, process_id, command_line, user\n    FROM process_logs\n    WHERE process_name IN ('powershell.exe', 'pwsh.exe')\n      AND (command_line LIKE '%DownloadString%'\n           OR command_line LIKE '%WebClient%'\n           OR command_line LIKE '%Net.Sockets%'\n           OR command_line LIKE '%-enc%')\n),\nnetwork_connections AS (\n    SELECT timestamp as conn_time, src_ip, dst_ip, dst_port, process_id\n    FROM network_logs\n    WHERE dst_port IN (80, 443, 8080, 8443)\n)\nSELECT \n    ps.ps_time, ps.host, ps.user, ps.command_line,\n    nc.conn_time, nc.dst_ip, nc.dst_port,\n    EXTRACT(EPOCH FROM (nc.conn_time - ps.ps_time)) as seconds_between\nFROM powershell_exec ps\nJOIN network_connections nc \n    ON ps.host = nc.src_ip \n    AND ps.process_id = nc.process_id\n    AND nc.conn_time BETWEEN ps.ps_time AND ps.ps_time + INTERVAL '2 minutes'\nORDER BY ps.ps_time DESC;",
      "log_types": [
        "Windows Event Logs",
        "Sysmon",
        "Network Logs",
        "Firewall"
      ],
      "time_window": "2 minutes",
      "techniques": [
        "T1059.001",
        "T1071"
      ]
    }
  ],
  "anomaly_detection": [
    {
      "anomaly_type": "Rare Process-Parent Relationship",
      "description": "Detect unusual parent-child process relationships indicative of compromise",
      "sql_query": "\n-- Detect anomalous process relationships\nWITH normal_relationships AS (\n    SELECT parent_process, process_name, COUNT(*) as frequency\n    FROM process_logs\n    WHERE timestamp > CURRENT_DATE - INTERVAL '30 days'\n    GROUP BY parent_process, process_name\n    HAVING COUNT(*) > 10  -- Seen more than 10 times = \"normal\"\n)\nSELECT p.timestamp, p.host, p.user, p.parent_process, p.process_name, p.command_line\nFROM process_logs p\nLEFT JOIN normal_relationships nr \n    ON p.parent_process = nr.parent_process \n    AND p.process_name = nr.process_name\nWHERE nr.frequency IS NULL  -- Not in our \"normal\" set\n  AND p.parent_process NOT IN ('explorer.exe', 'services.exe', 'svchost.exe')\nORDER BY p.timestamp DESC;",
      "log_types": [
        "Windows Event Logs",
        "Sysmon"
      ],
      "baseline_required": true
    },
    {
      "anomaly_type": "Unusual Outbound Connections",
      "description": "Detect hosts making connections to rare/new external IPs",
      "sql_query": "\n-- Identify connections to previously unseen destinations\nWITH historical_destinations AS (\n    SELECT DISTINCT dst_ip\n    FROM network_logs\n    WHERE timestamp BETWEEN CURRENT_DATE - INTERVAL '30 days' AND CURRENT_DATE - INTERVAL '1 day'\n),\nrecent_connections AS (\n    SELECT timestamp, src_ip, dst_ip, dst_port, bytes_sent\n    FROM network_logs\n    WHERE timestamp > CURRENT_DATE - INTERVAL '1 day'\n      AND dst_ip NOT IN (SELECT ip FROM internal_ip_ranges)\n)\nSELECT rc.*\nFROM recent_connections rc\nLEFT JOIN historical_destinations hd ON rc.dst_ip = hd.dst_ip\nWHERE hd.dst_ip IS NULL  -- Never seen before\nORDER BY rc.timestamp DESC;",
      "log_types": [
        "Firewall",
        "Network Logs",
        "Proxy"
      ],
      "baseline_required": true
    },
    {
      "anomaly_type": "Off-Hours Activity",
      "description": "Detect APT29 techniques occurring during off-hours",
      "sql_query": "\n-- Activity during unusual hours (customize for your organization)\nSELECT timestamp, host, user, process_name, command_line\nFROM process_logs\nWHERE (\n    -- Off-hours: Before 6 AM or after 8 PM, or weekends\n    EXTRACT(HOUR FROM timestamp) < 6 \n    OR EXTRACT(HOUR FROM timestamp) > 20\n    OR EXTRACT(DOW FROM timestamp) IN (0, 6)  -- Sunday, Saturday\n)\nAND (\n    process_name IN ('powershell.exe', 'cmd.exe', 'wscript.exe')\n    OR command_line LIKE '%net user%'\n    OR command_line LIKE '%net group%'\n    OR command_line LIKE '%psexec%'\n)\nORDER BY timestamp DESC;",
      "log_types": [
        "Windows Event Logs",
        "Sysmon"
      ],
      "baseline_required": false
    }
  ]
}